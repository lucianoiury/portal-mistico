<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossos Tarólogos - Portal Místico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .font-cinzel { font-family: 'Cinzel', serif; }
    </style>
</head>
<body class="text-gray-200">

    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-purple-900/50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold font-cinzel text-purple-300">
                Portal Místico
            </a>
            <div>
                <a href="dashboard.html" class="hover:text-purple-300 transition-colors">Meu Painel</a>
            </div>
        </nav>
    </header>

    <main id="main-content" class="container mx-auto p-8">
        <div class="text-center">
            <h1 class="text-4xl font-cinzel text-purple-300 mb-4">Nossos Oraculistas</h1>
            <p class="text-lg text-gray-400 mb-8">Conecte-se com especialistas e encontre as respostas que procura.</p>
        </div>

        <div id="loader" class="text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500 mx-auto"></div>
            <p class="mt-4">A encontrar os tarólogos disponíveis...</p>
        </div>

        <div id="tarot-readers-container" class="hidden mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Cards dos Tarólogos serão inseridos aqui -->
        </div>
    </main>

    <script src="auth-config.js"></script>
    <script>
        window.addEventListener('load', async () => {
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            const currentUser = session.user;
            const loader = document.getElementById('loader');
            const container = document.getElementById('tarot-readers-container');

            async function loadTarotReaders() {
                // Busca todos os perfis que têm a função 'tarologo'
                const { data: readers, error } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name')
                    .eq('role', 'tarologo');

                loader.style.display = 'none';

                if (error) {
                    container.innerHTML = `<p class="text-red-400 text-center col-span-full">Erro ao carregar os tarólogos.</p>`;
                    container.classList.remove('hidden');
                    return;
                }
                
                if (readers.length === 0) {
                    container.innerHTML = `<p class="text-gray-400 text-center col-span-full">Nenhum tarólogo disponível no momento.</p>`;
                } else {
                     readers.forEach(reader => {
                        // Não mostra o próprio utilizador na lista se ele for um tarólogo
                        if(reader.id === currentUser.id) return;

                        const readerCard = `
                            <div class="bg-gray-800/50 p-6 rounded-lg border border-purple-900 text-center">
                                <img src="https://placehold.co/150x150/7b2cbf/FFFFFF?text=${reader.full_name.charAt(0)}" alt="[Foto de ${reader.full_name}]" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-purple-800">
                                <h2 class="text-2xl font-bold text-purple-300">${reader.full_name}</h2>
                                <p class="text-gray-400 mt-2">Tarólogo(a) Especialista</p>
                                <button data-reader-id="${reader.id}" class="start-chat-btn mt-6 bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 w-full">
                                    Iniciar Consulta
                                </button>
                            </div>
                        `;
                        container.innerHTML += readerCard;
                    });
                }
                
                container.classList.remove('hidden');
                addEventListeners();
            }

            function addEventListeners() {
                document.querySelectorAll('.start-chat-btn').forEach(button => {
                    button.addEventListener('click', startChat);
                });
            }

            async function startChat(e) {
                const readerId = e.target.getAttribute('data-reader-id');
                e.target.disabled = true;
                e.target.textContent = "A verificar...";

                // 1. Verificar se o cliente tem créditos
                const { data: profile, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('chat_credits_minutes')
                    .eq('id', currentUser.id)
                    .single();

                if (profileError || !profile || profile.chat_credits_minutes < 1) {
                    alert("Você não tem créditos de chat suficientes. Por favor, compre mais minutos para continuar.");
                    window.location.href = 'creditos.html';
                    return;
                }

                // 2. Criar a nova conversa
                const { data: conversation, error: conversationError } = await supabaseClient
                    .from('conversations')
                    .insert({
                        client_id: currentUser.id,
                        tarot_reader_id: readerId,
                        status: 'active' // Inicia a conversa como ativa
                    })
                    .select()
                    .single();
                
                if (conversationError) {
                    alert("Erro ao iniciar a conversa. Tente novamente.");
                    e.target.disabled = false;
                    e.target.textContent = "Iniciar Consulta";
                    return;
                }

                // 3. Redirecionar para a página do chat, passando o ID da conversa
                window.location.href = `chat.html?id=${conversation.id}`;
            }

            loadTarotReaders();
        });
    </script>
</body>
</html>
