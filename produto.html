<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produto - Portal Místico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        .font-cinzel { font-family: 'Cinzel', serif; }
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="text-gray-200">

    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-50 border-b border-purple-900/50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="dashboard.html" class="text-2xl font-bold font-cinzel text-purple-300">Portal Místico</a>
            <div class="hidden md:flex items-center space-x-6">
                <a href="loja.html" class="hover:text-purple-300 transition-colors">Loja</a>
                <a href="tarologos.html" class="hover:text-purple-300 transition-colors">Tarólogos</a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="carrinho.html" class="relative hover:text-purple-300 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-shopping-cart"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                </a>
                <a href="dashboard.html" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Meu Painel</a>
            </div>
        </nav>
    </header>

    <main id="main-content" class="container mx-auto p-8 opacity-0 transition-opacity duration-500">
        <!-- Detalhes do Produto -->
        <div id="product-details" class="grid grid-cols-1 md:grid-cols-2 gap-12">
            <!-- Imagem do Produto -->
            <div>
                <img id="product-image" src="https://placehold.co/600x600/111827/FFFFFF?text=Carregando..." alt="[Imagem do Produto]" class="w-full rounded-lg shadow-2xl">
            </div>
            <!-- Informações do Produto -->
            <div class="flex flex-col">
                <h1 id="product-name" class="text-4xl font-cinzel font-bold text-purple-300">Carregando nome...</h1>
                <p id="product-description" class="mt-4 text-gray-300 text-lg flex-grow">Carregando descrição...</p>
                <div class="mt-8">
                    <span id="product-price" class="text-5xl font-bold text-white">R$ --,--</span>
                </div>
                <div class="mt-8">
                    <button id="add-to-cart-button" class="w-full bg-green-600 text-white font-bold py-4 px-8 rounded-lg hover:bg-green-700 transition-colors text-xl">
                        Adicionar ao Carrinho
                    </button>
                </div>
            </div>
        </div>

        <!-- Secção de Avaliações -->
        <div class="mt-20">
            <h2 class="text-3xl font-cinzel text-center text-purple-300 mb-12">Avaliações dos Místicos</h2>
            
            <!-- Formulário para Nova Avaliação -->
            <div id="review-form-container" class="hidden mb-12 bg-gray-800/50 p-8 rounded-lg">
                <h3 class="text-xl font-bold mb-4">Deixe a sua avaliação</h3>
                <form id="review-form">
                    <div class="mb-4">
                        <label for="rating" class="block mb-2">Sua nota (1 a 5):</label>
                        <input type="number" id="rating" name="rating" min="1" max="5" required class="w-24 bg-gray-700 text-white p-2 rounded">
                    </div>
                    <div class="mb-4">
                        <label for="comment" class="block mb-2">Seu comentário:</label>
                        <textarea id="comment" name="comment" rows="4" required class="w-full bg-gray-700 text-white p-2 rounded"></textarea>
                    </div>
                    <button type="submit" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-purple-700">Enviar Avaliação</button>
                </form>
            </div>
            <div id="login-for-review" class="hidden text-center mb-12">
                 <a href="login.html" class="text-purple-400 hover:underline">Faça login para deixar uma avaliação.</a>
            </div>

            <!-- Lista de Avaliações Existentes -->
            <div id="reviews-list" class="space-y-6"></div>
        </div>
    </main>

    <!-- Notificação Toast -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-purple-600 text-white py-3 px-6 rounded-lg shadow-lg">
        Produto adicionado ao carrinho!
    </div>

    <script src="auth-config.js"></script>
    <script>
        window.addEventListener('load', async () => {
            const mainContent = document.getElementById('main-content');
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                mainContent.innerHTML = `<p class="text-center text-red-400">Produto não encontrado. Verifique o link.</p>`;
                mainContent.style.opacity = '1';
                return;
            }

            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            let currentUser = null;

            async function loadProductDetails() {
                const { data: product, error } = await supabaseClient.from('products').select('*').eq('id', productId).single();
                if (error || !product) {
                    mainContent.innerHTML = `<p class="text-center text-red-400">Não foi possível carregar os detalhes do produto.</p>`;
                    return;
                }
                document.getElementById('product-name').textContent = product.name;
                document.getElementById('product-image').src = product.image_url;
                document.getElementById('product-description').textContent = product.description;
                document.getElementById('product-price').textContent = `R$ ${product.price.toFixed(2).replace('.', ',')}`;
            }

            async function loadReviews() {
                const { data: reviews, error } = await supabaseClient.from('reviews').select('*, profiles(full_name)').eq('product_id', productId).order('created_at', { ascending: false });
                const reviewsList = document.getElementById('reviews-list');
                reviewsList.innerHTML = '';
                if (error) { reviewsList.innerHTML = `<p>Não foi possível carregar as avaliações.</p>`; return; }
                if (reviews.length === 0) {
                    reviewsList.innerHTML = `<p class="text-center text-gray-400">Este produto ainda não tem avaliações. Seja o primeiro!</p>`;
                } else {
                    reviews.forEach(review => {
                        const reviewCard = `<div class="bg-gray-800/30 p-6 rounded-lg border border-purple-900/20"><div class="flex items-center mb-2"><p class="font-bold text-purple-300">${review.profiles.full_name || 'Anónimo'}</p><span class="ml-auto text-yellow-400">${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}</span></div><p class="text-gray-300">${review.comment}</p><p class="text-xs text-gray-500 mt-2 text-right">${new Date(review.created_at).toLocaleDateString()}</p></div>`;
                        reviewsList.innerHTML += reviewCard;
                    });
                }
            }
            
            async function checkUserSession() {
                const { data: { session } } = await supabaseClient.auth.getSession();
                currentUser = session?.user || null;
                const reviewFormContainer = document.getElementById('review-form-container');
                const loginForReview = document.getElementById('login-for-review');
                if (currentUser) {
                    reviewFormContainer.classList.remove('hidden');
                    loginForReview.classList.add('hidden');
                } else {
                    reviewFormContainer.classList.add('hidden');
                    loginForReview.classList.remove('hidden');
                }
            }

            await loadProductDetails();
            await loadReviews();
            await checkUserSession();
            mainContent.style.opacity = '1';

            const reviewForm = document.getElementById('review-form');
            if(reviewForm) {
                reviewForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentUser) { alert("Você precisa estar logado para avaliar."); return; }
                    const { error } = await supabaseClient.from('reviews').insert({ product_id: productId, user_id: currentUser.id, rating: e.target.rating.value, comment: e.target.comment.value });
                    if(error) { alert("Erro ao enviar avaliação: " + error.message); } else { alert("Avaliação enviada com sucesso!"); e.target.reset(); await loadReviews(); }
                });
            }
            
            const addToCartButton = document.getElementById('add-to-cart-button');
            addToCartButton.addEventListener('click', async () => {
                if (!currentUser) {
                    alert("Por favor, faça login para adicionar produtos ao carrinho.");
                    window.location.href = 'login.html';
                    return;
                }
                const { data: existingItem } = await supabaseClient.from('cart_items').select('id, quantity').eq('user_id', currentUser.id).eq('product_id', productId).single();
                if (existingItem) {
                    const { error } = await supabaseClient.from('cart_items').update({ quantity: existingItem.quantity + 1 }).eq('id', existingItem.id);
                    if (error) { alert("Erro ao atualizar o produto no carrinho."); } else { showToast(); }
                } else {
                    const { error } = await supabaseClient.from('cart_items').insert({ user_id: currentUser.id, product_id: productId, quantity: 1 });
                    if (error) { alert("Erro ao adicionar o produto ao carrinho."); } else { showToast(); }
                }
            });

            function showToast() {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => { toast.classList.remove('show'); }, 3000);
            }
        });
    </script>
</body>
</html>