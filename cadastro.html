<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Portal Místico</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        h1, h2, h3, .font-cinzel {
            font-family: 'Cinzel', serif;
        }
        .form-container {
            background-color: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
        }
        /* Estilo para mensagens de feedback */
        #message-box {
            display: none; /* Começa escondido */
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-200 bg-cover bg-center" style="background-image: linear-gradient(rgba(17, 24, 39, 0.9), rgba(17, 24, 39, 1)), url('https://placehold.co/1920x1080/000000/FFFFFF?text=Universo+Mistico');">

    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md mx-auto">
        
            <div class="text-center mb-8">
                <a href="index.html" class="text-4xl font-bold font-cinzel text-purple-300">
                    Portal Místico
                </a>
                <h2 class="text-2xl text-white mt-2">Crie sua Conta</h2>
                <p class="text-gray-400">Junte-se à nossa comunidade mágica.</p>
            </div>

            <!-- Div para exibir mensagens de sucesso ou erro -->
            <div id="message-box" class="p-4 mb-4 text-sm text-center rounded-lg"></div>

            <div class="form-container border border-purple-900/50 rounded-2xl shadow-2xl p-8">
                <!-- Alterado para remover action e method, o JS cuidará disso -->
                <form id="signup-form" class="space-y-6">
                    <!-- Name Input -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-purple-200">Nome Completo</label>
                        <input type="text" id="name" name="name" required
                               class="mt-1 block w-full bg-gray-800/50 border border-purple-800 rounded-md shadow-sm py-3 px-4 text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>

                    <!-- Email Input -->
                    <div>
                        <label for="email" class="block text-sm font-medium text-purple-200">Email</label>
                        <input type="email" id="email" name="email" required
                               class="mt-1 block w-full bg-gray-800/50 border border-purple-800 rounded-md shadow-sm py-3 px-4 text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>

                    <!-- Password Input -->
                    <div>
                        <label for="password" class="block text-sm font-medium text-purple-200">Senha</label>
                        <input type="password" id="password" name="password" required minlength="6"
                               class="mt-1 block w-full bg-gray-800/50 border border-purple-800 rounded-md shadow-sm py-3 px-4 text-white focus:outline-none focus:ring-purple-500 focus:border-purple-500 transition">
                    </div>

                     <!-- User Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-purple-200">Você é:</label>
                        <div class="mt-2 grid grid-cols-2 gap-4">
                            <label for="is-client" class="flex items-center justify-center p-3 border border-purple-800 rounded-md cursor-pointer hover:bg-purple-900/50 transition has-[:checked]:bg-purple-600 has-[:checked]:border-purple-400">
                                <input type="radio" id="is-client" name="user-type" value="cliente" class="sr-only" required>
                                <span class="text-sm font-medium text-white">Cliente</span>
                            </label>
                            <label for="is-tarot-reader" class="flex items-center justify-center p-3 border border-purple-800 rounded-md cursor-pointer hover:bg-purple-900/50 transition has-[:checked]:bg-purple-600 has-[:checked]:border-purple-400">
                                <input type="radio" id="is-tarot-reader" name="user-type" value="tarologo" class="sr-only" required>
                                <span class="text-sm font-medium text-white">Tarólogo</span>
                            </label>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div>
                        <button type="submit"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-bold text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 transition-all duration-300">
                            Criar Conta
                        </button>
                    </div>
                </form>

                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-400">
                        Já tem uma conta?
                        <a href="login.html" class="font-medium text-purple-400 hover:text-purple-300">
                            Faça login
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Nosso script de configuração do Supabase. O 'defer' garante que o script será executado após a análise do HTML. -->
    <script src="auth-config.js" defer></script>

    <!-- Script para lidar com a lógica de autenticação -->
    <script>
        // Adiciona um listener para garantir que o DOM esteja completamente carregado antes de executar o script.
        document.addEventListener('DOMContentLoaded', () => {
            // Verifica se as variáveis do Supabase foram carregadas do arquivo auth-config.js
            if (typeof SUPABASE_URL === 'undefined' || typeof SUPABASE_KEY === 'undefined') {
                console.error('As variáveis do Supabase não foram encontradas. Verifique se o arquivo auth-config.js está correto e foi carregado.');
                showMessage('Erro de configuração. Não foi possível conectar ao servidor.', 'error');
                return;
            }

            const { createClient } = supabase;
            // Inicializa o cliente Supabase usando as variáveis do auth-config.js
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

            const signupForm = document.getElementById('signup-form');
            const messageBox = document.getElementById('message-box');

            signupForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Impede o envio padrão do formulário

                const form = event.target;
                const email = form.email.value;
                const password = form.password.value;
                const fullName = form.name.value;
                const userRole = form['user-type'].value;
                
                // 1. Tenta criar o usuário no serviço de autenticação do Supabase
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        // Armazena dados adicionais que não vão para a tabela auth.users
                        data: {
                            full_name: fullName,
                        }
                    }
                });

                if (authError) {
                    console.error('Erro no cadastro:', authError.message);
                    showMessage('Erro ao criar conta: ' + authError.message, 'error');
                    return;
                }

                if (authData.user) {
                     // 2. Se o usuário foi criado, insere o perfil na tabela 'profiles'
                    const { error: profileError } = await supabaseClient
                        .from('profiles')
                        .insert([
                            { 
                                id: authData.user.id, // Vincula com o usuário da autenticação
                                full_name: fullName,
                                role: userRole 
                            }
                        ]);

                    if (profileError) {
                        console.error('Erro ao criar perfil:', profileError.message);
                        showMessage('Sua conta foi criada, mas houve um erro ao salvar seu perfil. Contate o suporte.', 'error');
                        return;
                    }
                    
                    console.log('Usuário e perfil criados com sucesso!', authData);
                    showMessage('Cadastro realizado com sucesso! Verifique seu e-mail para confirmar a conta.', 'success');
                    signupForm.reset(); // Limpa o formulário
                }
            });

            // Função para exibir mensagens para o usuário
            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.style.display = 'block';

                if (type === 'success') {
                    messageBox.className = 'p-4 mb-4 text-sm text-center rounded-lg bg-green-800 text-green-200';
                } else if (type === 'error') {
                    messageBox.className = 'p-4 mb-4 text-sm text-center rounded-lg bg-red-800 text-red-200';
                } else {
                     messageBox.className = 'p-4 mb-4 text-sm text-center rounded-lg bg-blue-800 text-blue-200';
                }
            }
        });
    </script>

</body>
</html>
